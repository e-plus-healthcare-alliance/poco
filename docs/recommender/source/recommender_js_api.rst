Recommender JS API
===================

功能：用来在网页上集成用户行为跟踪和商品推荐功能。

简明教程
----------

JsSdk Demo页面 http://search.tuijianbao.net/sdk/demo/

在页面底部包含下面两个js文件::

    <script type="text/javascript" language="javascript" charset="utf-8" src="http://search.tuijianbao.net/sdk/js/api-1.6.js"></script>
    <script type="text/javascript" language="javascript" charset="utf-8" src="http://search.tuijianbao.net/sdk/skin/ui-1.6.js"></script>


API调用范例::

    <div id="search-results">
        <ul>
            <li><a href="http://example.com/product-1.html" class="result-link" data-item_id="1"></a></li>
            <li><a href="http://example.com/product-2.html" class="result-link" data-item_id="2"></a></li>
        </ul>
    </div>

    <script type="text/javascript" language="javascript" >
        var debug = true;
        var p = new _poco("<API Key>", "http://<api server prefix>/api/v1.6", debug);
        p.addSharedParams({'item_id': 'K8900',
                           'user_id': 'U123',
                           'amount': '6'});

        p.addEvent({"event_type": "ViewItem"});
        p.addEvent({"type": "PlaceOrder", "order_id": "O123", "order_content": "I123,1.50,2|I250,15.50,1"});
        // This is a custom event
        p.addEvent({"event_type": "CustomEvt1", "purchasing_amount": 15.0});
        p.addRecommender({"type": "AlsoViewed"});
        p.addRecommender({"type": "ByHotIndex", "hot_index_type": "viewed", "category_id": "C1", "brand": "B25"});

        // 跟踪用户链接点击事件。详见 _poco.track_links文档
        p.track_links("#search-results .result-link",
                      "SearchResult",
                      {"q": "haoyaoshi", "page": "1"});
        p.invoke("tjbCallback");
    </script>

_poco.addSharedParams
-------------------------

如果在此后一系列调用addEvent和addRecommender中，有若干参数是相同的，可以通过这种方式一次性指定。


_poco.addEvent参数列表
--------------------------

传入参数
^^^^^^^^^^^^^^

=================     ==========  ===============================   =============================================
参数名                是否必填    默认值                            描述
=================     ==========  ===============================   =============================================
event_type            是                                            事件类型，根据事件类型不同，需要的其他入参也会不同。
user_id               否                                            用户ID
api_key               是                                            分配给用户站点的api key
=================     ==========  ===============================   =============================================


事件类型
^^^^^^^^^
说明：事件类型分为两类。系统保留类型，和用户自定义类型。

系统保留类型，目前有下面所列8种。传入的参数必须符合下面的要求。

自定义类型名称可任意选择，但不能和保留类型相同。除了上面列出的"event_type", "user_id"和"api_key"必填之外，其他参数可以自行选择。

下面为系统保留类型及所需传入参数。
1. ViewItem: 

说明：用户浏览了该商品

=================     ==========  ===============================   =============================================
参数名                是否必填    默认值                            描述
=================     ==========  ===============================   =============================================
item_id               是                                            商品ID
=================     ==========  ===============================   =============================================


2. AddFavorite: 

说明：用户将该商品添加到收藏

=================     ==========  ===============================   =============================================
参数名                是否必填    默认值                            描述
=================     ==========  ===============================   =============================================
item_id               是                                            商品ID
=================     ==========  ===============================   =============================================

3. RemoveFavorite: 

说明：用户将该商品取消收藏

=================     ==========  ===============================   =============================================
参数名                是否必填    默认值                            描述
=================     ==========  ===============================   =============================================
item_id               是                                            商品ID
=================     ==========  ===============================   =============================================

4. RateItem: 用户给该商品打分

=================     ==========  ===============================   =============================================
参数名                是否必填    默认值                            描述
=================     ==========  ===============================   =============================================
item_id               是                                            商品ID
score                 是                                            商品打分 (1-5)
=================     ==========  ===============================   =============================================


5. AddOrderItem

说明：用户将商品添加到购物车中

=================     ==========  ===============================   =============================================
参数名                是否必填    默认值                            描述
=================     ==========  ===============================   =============================================
item_id               是                                            商品ID
=================     ==========  ===============================   =============================================

6. RemoveOrderItem

说明：用户将商品从购物车中移除

=================     ==========  ===============================   =============================================
参数名                是否必填    默认值                            描述
=================     ==========  ===============================   =============================================
item_id               是                                            商品ID
=================     ==========  ===============================   =============================================

7. PlaceOrder

说明：用户下单操作

=================     ==========  ===============================   =============================================
参数名                是否必填    默认值                            描述
=================     ==========  ===============================   =============================================
order_content         是                                            用户订单内容。格式：item_id,price,amount|item_id,price,amount
order_id              否                                            订单号
=================     ==========  ===============================   =============================================

举例：
假设用户下单购买id为001的价格为5.50的商品2件，id为005的价格为8.00的商品1件，则order_content应该为"001,5.50,2|005,8.00,1"

8. ClickLink

说明：用户点击链接事件。在必填参数之外，此事件还可以传入其他自定义参数。

=================     ==========  ===============================   =============================================
参数名                是否必填    默认值                            描述
=================     ==========  ===============================   =============================================
link_type             是                                            链接类型。
link_url              是                                            链接URL
=================     ==========  ===============================   =============================================

9. Search

说明：用户使用搜索引擎搜索事件。建议在搜索结果页添加此事件。

=================     ==========  ===============================   =============================================
参数名                是否必填    默认值                            描述
=================     ==========  ===============================   =============================================
category_id           否                                            用户在哪个分类下进行该搜索。如果没有指定分类，则不用传入。
q                     是                                            用户输入的查询字符串
=================     ==========  ===============================   =============================================

示例::

    假设本页面是"牛黄解毒丸"的搜索结果页面，那么为了跟踪此次搜索事件，可添加如下
    var p = new _poco("<API Key>", "http://<api server prefix>/api/v1.6", debug);
    ... ...
    // 假设此次搜索没有指定分类
    p.addEvent({"event_type": "Search", "user_id": "U1", "category_id": "null", "q": "牛黄解毒丸"})
    // 或者如果此次搜索指定了分类1233
    p.addEvent({"event_type": "Search", "user_id": "U1", "category_id": "1233", "q": "牛黄解毒丸"})

_poco.addRecommender
--------------------------------

通用传入参数
^^^^^^^^^^^^^^

=================     ==========  ===============================   =============================================
参数名                是否必填    默认值                            描述
=================     ==========  ===============================   =============================================
type                  是                                            推荐类型，根据推荐类型不同，需要的其他入参也会不同。
amount                是                                            需要返回结果数
user_id               是                                            用户ID
api_key               是                                            分配给用户站点的api key
=================     ==========  ===============================   =============================================

推荐类型
^^^^^^^^^

推荐分为两种，一种是下列8种系统内置的推荐类型。另一种是为用户站点特别订制的推荐类型。

为好药师特别订制的类型包括:

1. /unit/home

说明：首页上为用户显示的推荐：首先根据用户的浏览历史推荐。如果根据用户浏览历史无法推荐出结果，则返回浏览排行榜。

=============    ==========  ===============================   =============================================
参数名           是否必填    默认值                            描述
=============    ==========  ===============================   =============================================
user_id          是
=============    ==========  ===============================   =============================================


2. /unit/item

说明：在商品信息页上根据商品信息推荐相关商品，如果找不到相关商品，则推荐该商品的同分类中的其他热门浏览商品。如果该分类中其他热门浏览商品也找不到，则推荐全站热门浏览商品。

=============    ==========  ===============================   =============================================
参数名           是否必填    默认值                            描述
=============    ==========  ===============================   =============================================
item_id          是                                            商品ID
=============    ==========  ===============================   =============================================


内置的推荐类型包括：

1. AlsoViewed

说明：看过此商品的用户也看过哪些商品

=============    ==========  ===============================   =============================================
参数名           是否必填    默认值                            描述
=============    ==========  ===============================   =============================================
item_id          是                                            商品ID
=============    ==========  ===============================   =============================================

2. ByBrowsingHistory

说明：根据用户浏览历史推荐。

=============    ==========  ===============================   =============================================
参数名           是否必填    默认值                            描述
=============    ==========  ===============================   =============================================
user_id          是                                            用户ID
=============    ==========  ===============================   =============================================


3. AlsoBought

说明：买过该商品的用户也买过哪些商品

=============    ==========  ===============================   =============================================
参数名           是否必填    默认值                            描述
=============    ==========  ===============================   =============================================
item_id          是                                            商品ID
=============    ==========  ===============================   =============================================

4. BoughtTogether

说明：经常和该商品在一起购买的商品

=============    ==========  ===============================   =============================================
参数名           是否必填    默认值                            描述
=============    ==========  ===============================   =============================================
item_id          是                                            商品ID
=============    ==========  ===============================   =============================================

5. UltimatelyBought

说明：看了该商品的用户最终购买哪些商品

=============    ==========  ===============================   =============================================
参数名           是否必填    默认值                            描述
=============    ==========  ===============================   =============================================
item_id          是                                            商品ID
=============    ==========  ===============================   =============================================

6. ByPurchasingHistory

说明：根据购买历史推荐

7. ByShoppingCart

=============    ==========  ===============================   =============================================
参数名           是否必填    默认值                            描述
=============    ==========  ===============================   =============================================
shopping_cart    否                                            购物车中商品的ID，以逗号分隔。
=============    ==========  ===============================   =============================================

8. ByHotIndex

说明：根据热门浏览/热门销售排行榜来推荐。如果category_id和brand都不填写，则返回总排行榜。(目前暂不支持同时指定分类和品牌

==============    ==========  ===============================   =============================================
参数名            是否必填    默认值                            描述
==============    ==========  ===============================   =============================================
hot_index_type    是                                            viewed: 取浏览排行榜；bought: 取购买排行榜
category_id       否                                            指定分类。
brand             否                                            指定品牌
==============    ==========  ===============================   =============================================


_poco.track_links
--------------------------------

说明：track_links是用来跟踪用户点击链接的事件。

track_links(css_selector, link_type, shared_params)

调用该方法，会注册选中的每个链接的点击事件。当某个链接被用户点击后，会向events api发送一个用户点击事件(ClickLink)。该事件的参数包括三个部分：
    1. "link_type"为传入的link_type参数，"url"为所点击链接的url。
    2. shared_params是一个hash类型，其中所有的键值对也将作为这次事件的参数传入。
    3. 在每个链接元素上可以添加一些"data-"开头的attribute, 这些属性也会作为这次事件的参数传入。


举例::

        假设我们需要跟踪搜索结果页上的链接点击事件。这些链接的HTML代码如下：
        <div id="search-results">
            <ul>
                <li><a href="http://example.com/product-1.html" data-item_id="1">Search Result 001</a></li>
                <li><a href="http://example.com/product-2.html" data-item_id="2">Search Result 002</a></li>
            </ul>
        </div>

        其中在data-item_id属性中，为每个链接设置了其相关的item id。

        然后我们加入如下JS代码。
        <script>
        var p = new _poco("<API Key>", "http://<api server prefix>/api/v1.6", debug);
        ... ...
        p.track_links("#search-results .result-link",
                      "SearchResult",
                      {"q": "haoyaoshi", "page": "1"});
        </script>
        这次track_links调用将注册上面那些搜索链接的点击事件。因为我们是要跟踪搜索结果的链接点击，所以link_type为"SearchResult"。我们希望跟踪这些链接是来自什么样的搜索，所以将shared_params中设置q和page两个参数。这样每一个链接的点击事件都会记录查询字符串和搜索结果页的页码。
        当某个链接被点击后，它上面的data-item_id属性也会被搜集起来，作为事件的参数。
        假如我们点击上面第一个链接，就会向服务器发送如下的事件内容：
        {"event_type": "ClickLink", "link_type": "SearchResult", "q": "haoyaoshi", "page": "1", "item_id": "1"}
